<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Scan Kehadiran</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  
  <style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#000;
  color:white;
}

/* HEADER ATAS */
.topbar{
  text-align:center;
  padding:12px;
  font-size:18px;
  font-weight:bold;
  background:#111;
}

/* AREA KAMERA */
#reader{
  width:100vw;
  height:70vh;
  position:relative;
}

/* PAKSA VIDEO FULL */
#reader video{
  width:100% !important;
  height:100% !important;
  object-fit:cover !important;
  border-radius:12px;
}

/* STATUS BAWAH */
#status{
  text-align:center;
  padding:14px;
  font-size:16px;
  background:#111;
}
.success{color:green}
.error{color:red}
</style>
</head>

<body>
<div class="topbar">Scan QR Kehadiran</div>
<div id="reader"></div>
<div id="status">Arahkan kamera ke QR tamu</div>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyAbFiLWZS5H1672SpouCn1deEAAn4qVqDs",
  databaseURL: "https://undanganwidi-default-rtdb.asia-southeast1.firebasedatabase.app"
});

const db = firebase.database();

/* QR SCAN */
const qr = new Html5Qrcode("reader");

const qr = new Html5Qrcode("reader");

function startScanner(){
  qr.start(
    { facingMode: { exact: "environment" } }, // paksa kamera belakang
    {
      fps: 10,
      aspectRatio: 1.777,        // bikin tampilan lebar (16:9)
      qrbox: (viewfinderWidth, viewfinderHeight) => {
        const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
        const qrSize = Math.floor(minEdge * 0.6);
        return { width: qrSize, height: qrSize };
      }
    },
    onScanSuccess
  );
}

function onScanSuccess(decodedText){
  const [idTamu, nama] = decodedText.split("|");
  if(!idTamu) return;

  const ref = db.ref("bukutamu/" + idTamu);

  ref.update({
    nama: nama,
    hadir: true,
    waktuHadir: Date.now()
  });

  document.getElementById("status").innerHTML =
    "✅ Hadir: <b>"+nama+"</b>";
}

startScanner();
    // hasil: id|nama
    const [idTamu, nama] = decodedText.split("|");

    if(!idTamu) return;

    const ref = db.ref("bukutamu/" + idTamu);

ref.once("value", snap => {

  // kalau data tamu BELUM ADA
  if(!snap.exists()){
    ref.set({
      nama: nama,
      hadir: true,
      waktuHadir: Date.now(),
      pesan: "",
      like: 0
    });
  }

  // kalau SUDAH ADA (misalnya sudah kirim ucapan)
  else{
    ref.update({
      hadir: true,
      waktuHadir: Date.now()
    });
  }

});

    document.getElementById("status").innerHTML =
      "✅ Kehadiran dicatat: <b>" + nama + "</b>";

    qr.stop();
  }
);
</script>
</body>
</html>
